<!doctype html><html class=no-js lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://seanslma.github.io/maki/Python/Blog/GroupbyApplyPerf/ rel=canonical><link href=../CachesinPython/ rel=prev><link href=../NumbaPerf/ rel=next><link href=../../../assets/images/favicon.png rel=icon><meta content="mkdocs-1.6.1, mkdocs-material-9.6.15" name=generator><title>How I reduced a Python app run time from two hours to 20 seconds? - maki</title><link href=../../../assets/stylesheets/main.342714a4.min.css rel=stylesheet><link href=../../../assets/stylesheets/palette.06af60db.min.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback" rel=stylesheet><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link href=../../../stylesheets/extra.css rel=stylesheet><script>__md_scope=new URL(`../../..`,location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+`.`+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+`.`+e,JSON.stringify(_))}catch{}};</script><body data-md-color-accent=indigo data-md-color-primary=indigo data-md-color-scheme=default dir=ltr><input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox><input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox><label class=md-overlay for=__drawer></label><div data-md-component=skip><a class=md-skip href=#how-i-reduced-a-python-app-run-time-from-two-hours-to-20-seconds> Skip to content </a></div><div data-md-component=announce></div><header class=md-header data-md-component=header><nav class="md-header__inner md-grid" aria-label=Header><a class="md-header__button md-logo" aria-label=maki data-md-component=logo href=../../.. title=maki> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a><label class="md-header__button md-icon" for=__drawer><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> maki </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> How I reduced a Python app run time from two hours to 20 seconds? </span></div></div></div><form class=md-header__option data-md-component=palette><input aria-label="Switch to dark mode" class=md-option data-md-color-accent=indigo data-md-color-media data-md-color-primary=indigo data-md-color-scheme=default id=__palette_0 name=__palette type=radio><label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label><input aria-label="Switch to light mode" class=md-option data-md-color-accent=indigo data-md-color-media data-md-color-primary=indigo data-md-color-scheme=slate id=__palette_1 name=__palette type=radio><label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label></form><script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script><label class="md-header__button md-icon" for=__search><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input aria-label=Search autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query placeholder=Search required spellcheck=false><label class="md-search__icon md-icon" for=__search><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg></label><nav aria-label=Search class=md-search__options><button class="md-search__icon md-icon" aria-label=Clear tabindex=-1 title=Clear type=reset><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav><div class=md-search__suggest data-md-component=search-suggest></div></form><div class=md-search__output><div class=md-search__scrollwrap data-md-scrollfix tabindex=0><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta>Initializing search</div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div><div class=md-header__source><a title="Go to repository" class=md-source data-md-component=source href=https://github.com/seanslma/maki> <div class="md-source__icon md-icon"><svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg></div> <div class=md-source__repository>GitHub</div> </a></div></nav></header><div class=md-container data-md-component=container><nav aria-label=Tabs class=md-tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a class=md-tabs__link href=../../..> About </a><li class=md-tabs__item><a class=md-tabs__link href=../../../AI/ChatGPT/> AI </a><li class=md-tabs__item><a class=md-tabs__link href=../../../AWS/CDN/> AWS </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Azure/Advisor/> Azure </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Coding/Notepad%2B%2B/> Coding </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Cybersecurity/Cybersecurity/> Cybersecurity </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Data/Data/> Data </a><li class=md-tabs__item><a class=md-tabs__link href=../../../DevOps/DevOps/> DevOps </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Documentation/Jira/> Documentation </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Energy/Inertia/> Energy </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Learn/Book/> Learn </a><li class=md-tabs__item><a class=md-tabs__link href=../../../ML/Backtest/> ML </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Optimizaton/Convex/> Optimizaton </a><li class=md-tabs__item><a class=md-tabs__link href=../../../PowerBI/Basic/> PowerBI </a><li class="md-tabs__item md-tabs__item--active"><a class=md-tabs__link href=../../NAN/> Python </a><li class=md-tabs__item><a class=md-tabs__link href=../../../SQL/Database/> SQL </a><li class=md-tabs__item><a class=md-tabs__link href=../../../System/Behavior/> System </a></ul></div></nav><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0><label class=md-nav__title for=__drawer><a class="md-nav__button md-logo" aria-label=maki data-md-component=logo href=../../.. title=maki> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> maki</label><div class=md-nav__source><a title="Go to repository" class=md-source data-md-component=source href=https://github.com/seanslma/maki> <div class="md-source__icon md-icon"><svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg></div> <div class=md-source__repository>GitHub</div> </a></div><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../../..> <span class=md-ellipsis> About </span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../AI/ChatGPT/> <span class=md-ellipsis> AI </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../AWS/CDN/> <span class=md-ellipsis> AWS </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Azure/Advisor/> <span class=md-ellipsis> Azure </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Coding/Notepad%2B%2B/> <span class=md-ellipsis> Coding </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Cybersecurity/Cybersecurity/> <span class=md-ellipsis> Cybersecurity </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Data/Data/> <span class=md-ellipsis> Data </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../DevOps/DevOps/> <span class=md-ellipsis> DevOps </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Documentation/Jira/> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Energy/Inertia/> <span class=md-ellipsis> Energy </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Learn/Book/> <span class=md-ellipsis> Learn </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../ML/Backtest/> <span class=md-ellipsis> ML </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Optimizaton/Convex/> <span class=md-ellipsis> Optimizaton </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../PowerBI/Basic/> <span class=md-ellipsis> PowerBI </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle" checked id=__nav_15 type=checkbox> <label class=md-nav__link for=__nav_15 id=__nav_15_label><span class=md-ellipsis> Python </span> <span class="md-nav__icon md-icon"></span></label> <nav aria-expanded=true aria-labelledby=__nav_15_label class=md-nav data-md-level=1><label class=md-nav__title for=__nav_15><span class="md-nav__icon md-icon"></span> Python</label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../../NAN/> <span class=md-ellipsis> NaN </span> </a><li class=md-nav__item><a class=md-nav__link href=../../Python/> <span class=md-ellipsis> Python </span> </a><li class=md-nav__item><a class=md-nav__link href=../../basic/> <span class=md-ellipsis> basic </span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../API/API/> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../App/Module/> <span class=md-ellipsis> App </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Architect/Decorator/> <span class=md-ellipsis> Architect </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Async/Asyncio/> <span class=md-ellipsis> Async </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--active md-nav__item--nested"><input class="md-nav__toggle md-toggle" checked id=__nav_15_8 type=checkbox> <label class=md-nav__link for=__nav_15_8 id=__nav_15_8_label tabindex=0><span class=md-ellipsis> Blog </span> <span class="md-nav__icon md-icon"></span></label> <nav aria-expanded=true aria-labelledby=__nav_15_8_label class=md-nav data-md-level=2><label class=md-nav__title for=__nav_15_8><span class="md-nav__icon md-icon"></span> Blog</label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../BestPractices/> <span class=md-ellipsis> Python Programing Bets Practice </span> </a><li class=md-nav__item><a class=md-nav__link href=../CachesinPython/> <span class=md-ellipsis> Caches used in Python </span> </a><li class="md-nav__item md-nav__item--active"><input class="md-nav__toggle md-toggle" id=__toc type=checkbox> <label class="md-nav__link md-nav__link--active" for=__toc><span class=md-ellipsis> How I reduced a Python app run time from two hours to 20 seconds? </span> <span class="md-nav__icon md-icon"></span></label> <a class="md-nav__link md-nav__link--active" href=./> <span class=md-ellipsis> How I reduced a Python app run time from two hours to 20 seconds? </span> </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> Table of contents</label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=#dummy-data-for-testing> <span class=md-ellipsis> Dummy data for testing </span> </a><li class=md-nav__item><a class=md-nav__link href=#getting-last-consecutive-date> <span class=md-ellipsis> Getting last consecutive date </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-pandas-dfgroupbyapply> <span class=md-ellipsis> Using Pandas df.groupby.apply </span> </a><li class=md-nav__item><a class=md-nav__link href=#avoiding-repeated-query-and-filtering> <span class=md-ellipsis> Avoiding repeated query and filtering </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-a-python-for-loop> <span class=md-ellipsis> Using a Python for-loop </span> </a><li class=md-nav__item><a class=md-nav__link href=#vectorized-process-without-for-loop> <span class=md-ellipsis> Vectorized process without for-loop </span> </a><li class=md-nav__item><a class=md-nav__link href=#summary> <span class=md-ellipsis> summary </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=../NumbaPerf/> <span class=md-ellipsis> Make Python Loops 5x to 10x Faster Using Numba </span> </a><li class=md-nav__item><a class=md-nav__link href=../PackageManagement/> <span class=md-ellipsis> How to manage python package dependencies </span> </a><li class=md-nav__item><a class=md-nav__link href=../PandasExplodeDateRange/> <span class=md-ellipsis> How to explode date ranges in a Pandas DataFrame 30x faster </span> </a><li class=md-nav__item><a class=md-nav__link href=../PandasTestDataFrame/> <span class=md-ellipsis> How to create dummy Pandas DataFrames for testing </span> </a><li class=md-nav__item><a class=md-nav__link href=../ReadCSVPerf/> <span class=md-ellipsis> Read CSV Files 10x to 40x Faster Using pyarrow and polars </span> </a><li class=md-nav__item><a class=md-nav__link href=../ReadExcelPerf/> <span class=md-ellipsis> Read Excel performance </span> </a><li class=md-nav__item><a class=md-nav__link href=../ReadParquetPerf/> <span class=md-ellipsis> Read parquet performance </span> </a><li class=md-nav__item><a class=md-nav__link href=../ReadSqlDataType/> <span class=md-ellipsis> The Pandas Function pd.read_sql Returns An Empty DataFrame Without Correct Data Types </span> </a><li class=md-nav__item><a class=md-nav__link href=../SqlSslSecurityLevel/> <span class=md-ellipsis> Login Timeout From Ubuntu 22.04 To SQL Server Database </span> </a></ul></nav><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../CLI/Click/> <span class=md-ellipsis> CLI </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Cache/Aiocache/> <span class=md-ellipsis> Cache </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Celery/Example/> <span class=md-ellipsis> Celery </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Class/ClassMethod/> <span class=md-ellipsis> Class </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Conda/Bashrc/> <span class=md-ellipsis> Conda </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Dash/Callback/> <span class=md-ellipsis> Dash </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Dask/Config/> <span class=md-ellipsis> Dask </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../DataType/Dictionary/> <span class=md-ellipsis> DataType </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../DateTime/Conversion/> <span class=md-ellipsis> DateTime </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Django/Django/> <span class=md-ellipsis> Django </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Email/ExchangeLib/> <span class=md-ellipsis> Email </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Env/Env/> <span class=md-ellipsis> Env </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../ErrorHandling/Exception/> <span class=md-ellipsis> ErrorHandling </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Excel/Excel/> <span class=md-ellipsis> Excel </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Flask/Request/> <span class=md-ellipsis> Flask </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Format/Black/> <span class=md-ellipsis> Format </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Generator/Generator/> <span class=md-ellipsis> Generator </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../IO/AzureBlob/> <span class=md-ellipsis> IO </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Issue/Main/> <span class=md-ellipsis> Issue </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Jupyter/Dashboard/> <span class=md-ellipsis> Jupyter </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Logging/AzureLibraries/> <span class=md-ellipsis> Logging </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../MSOffice/Access/> <span class=md-ellipsis> MSOffice </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Math/Sparse/> <span class=md-ellipsis> Math </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../NumPy/LinearFit/> <span class=md-ellipsis> NumPy </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Package/CondaBuild/> <span class=md-ellipsis> Package </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Pandas/Advance/> <span class=md-ellipsis> Pandas </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../PandasUpgradeTest/Datetime/> <span class=md-ellipsis> PandasUpgradeTest </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Parallel/Example/> <span class=md-ellipsis> Parallel </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Performance/Deadlock/> <span class=md-ellipsis> Performance </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Pip/Pip/> <span class=md-ellipsis> Pip </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Polars/CSV/> <span class=md-ellipsis> Polars </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../PyArrow/CSV/> <span class=md-ellipsis> PyArrow </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../PySpark/Column/> <span class=md-ellipsis> PySpark </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Pytorch/Install/> <span class=md-ellipsis> Pytorch </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Regex/Regex/> <span class=md-ellipsis> Regex </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../SQL/ADBC/> <span class=md-ellipsis> SQL </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../SQLAlchemy/BindParam/> <span class=md-ellipsis> SQLAlchemy </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../SSL/Cert/> <span class=md-ellipsis> SSL </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../SciPy/SparseMatrix/> <span class=md-ellipsis> SciPy </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Serialization/Benchmark/> <span class=md-ellipsis> Serialization </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Tensorflow/Install/> <span class=md-ellipsis> Tensorflow </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Test/Config/> <span class=md-ellipsis> Test </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Typing/tips/> <span class=md-ellipsis> Typing </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Visualization/Chart/> <span class=md-ellipsis> Visualization </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Web/Cherrypy/> <span class=md-ellipsis> Web </span> <span class="md-nav__icon md-icon"></span> </a></ul></nav><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../SQL/Database/> <span class=md-ellipsis> SQL </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../System/Behavior/> <span class=md-ellipsis> System </span> <span class="md-nav__icon md-icon"></span> </a></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav aria-label="Table of contents" class="md-nav md-nav--secondary"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> Table of contents</label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=#dummy-data-for-testing> <span class=md-ellipsis> Dummy data for testing </span> </a><li class=md-nav__item><a class=md-nav__link href=#getting-last-consecutive-date> <span class=md-ellipsis> Getting last consecutive date </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-pandas-dfgroupbyapply> <span class=md-ellipsis> Using Pandas df.groupby.apply </span> </a><li class=md-nav__item><a class=md-nav__link href=#avoiding-repeated-query-and-filtering> <span class=md-ellipsis> Avoiding repeated query and filtering </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-a-python-for-loop> <span class=md-ellipsis> Using a Python for-loop </span> </a><li class=md-nav__item><a class=md-nav__link href=#vectorized-process-without-for-loop> <span class=md-ellipsis> Vectorized process without for-loop </span> </a><li class=md-nav__item><a class=md-nav__link href=#summary> <span class=md-ellipsis> summary </span> </a></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><h1 id=how-i-reduced-a-python-app-run-time-from-two-hours-to-20-seconds>How I reduced a Python app run time from two hours to 20 seconds?<a title="Permanent link" class=headerlink href=#how-i-reduced-a-python-app-run-time-from-two-hours-to-20-seconds>¶</a></h1><p>Pandas <code>df.groupby.apply</code> is too slow for two Dataframes<p>We have a Python app that was too slow. It took about two hours to extract product forecast data from a database and to merge it with actual records. After some refactorization and optimization, I managed to reduce the run time to less than 20 seconds.<p>Assume we have some products and each has some daily sales revenue, the actual records. We also have daily forecast revenue. The task is to merge the actual and forecast data together.<p>Once there are missing records in the actual data, we believe that the actual revenue from that day are not reliable and they should be replaced with forecast data.<p>To finish this task, for each product, we need to first find the last consecutive date in the actual data and then get the forecast data after that date so we can merge the actual and forecast data together.<h2 id=dummy-data-for-testing>Dummy data for testing<a title="Permanent link" class=headerlink href=#dummy-data-for-testing>¶</a></h2><p>The performance of different implementations has been tested using some dummy data. I created dummy data using a function <code>gen_rand_df</code> that is described in <a href=https://medium.com/@sean.lma/how-to-create-dummy-pandas-dataframes-for-testing-cf03c52878e3>my previous post</a>. I also used a function <code>explode_date_range</code> in <a href=https://python.plainenglish.io/how-to-explode-date-ranges-in-a-pandas-dataframe-30x-faster-cb76519c7acf>my another post</a> to explode date ranges.<p>Firstly, we create some product info with <code>product_id</code>, <code>start_date</code> and <code>end_date</code> for the actual sales records and expand the date ranges to daily records.<div class=highlight><pre><span></span><code><a href=#__codelineno-0-1 id=__codelineno-0-1 name=__codelineno-0-1></a><span class=n>nrow</span> <span class=o>=</span> <span class=mi>5000</span>
<a href=#__codelineno-0-2 id=__codelineno-0-2 name=__codelineno-0-2></a><span class=n>d1</span> <span class=o>=</span> <span class=n>gen_rand_df</span><span class=p>(</span>
<a href=#__codelineno-0-3 id=__codelineno-0-3 name=__codelineno-0-3></a>    <span class=n>nrow</span><span class=o>=</span><span class=n>nrow</span><span class=p>,</span>
<a href=#__codelineno-0-4 id=__codelineno-0-4 name=__codelineno-0-4></a>    <span class=n>str_cols</span><span class=o>=</span><span class=p>{</span>
<a href=#__codelineno-0-5 id=__codelineno-0-5 name=__codelineno-0-5></a>        <span class=s1>'count'</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
<a href=#__codelineno-0-6 id=__codelineno-0-6 name=__codelineno-0-6></a>        <span class=s1>'name'</span><span class=p>:</span> <span class=s1>'product_id'</span><span class=p>,</span>
<a href=#__codelineno-0-7 id=__codelineno-0-7 name=__codelineno-0-7></a>        <span class=s1>'str_len'</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
<a href=#__codelineno-0-8 id=__codelineno-0-8 name=__codelineno-0-8></a>        <span class=s1>'str_cnt'</span><span class=p>:</span> <span class=n>nrow</span><span class=p>,</span>
<a href=#__codelineno-0-9 id=__codelineno-0-9 name=__codelineno-0-9></a>    <span class=p>},</span>
<a href=#__codelineno-0-10 id=__codelineno-0-10 name=__codelineno-0-10></a>    <span class=n>ts_cols</span><span class=o>=</span><span class=p>{</span>
<a href=#__codelineno-0-11 id=__codelineno-0-11 name=__codelineno-0-11></a>        <span class=s1>'count'</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
<a href=#__codelineno-0-12 id=__codelineno-0-12 name=__codelineno-0-12></a>        <span class=s1>'name'</span><span class=p>:</span> <span class=p>[</span><span class=s1>'start_date'</span><span class=p>,</span> <span class=s1>'end_date'</span><span class=p>],</span>
<a href=#__codelineno-0-13 id=__codelineno-0-13 name=__codelineno-0-13></a>        <span class=s1>'start_date'</span><span class=p>:</span> <span class=s1>'2025-01-01'</span><span class=p>,</span>
<a href=#__codelineno-0-14 id=__codelineno-0-14 name=__codelineno-0-14></a>        <span class=s1>'end_date'</span><span class=p>:</span> <span class=s1>'2035-01-01'</span><span class=p>,</span>
<a href=#__codelineno-0-15 id=__codelineno-0-15 name=__codelineno-0-15></a>        <span class=s1>'freq'</span><span class=p>:</span> <span class=s1>'D'</span><span class=p>,</span>
<a href=#__codelineno-0-16 id=__codelineno-0-16 name=__codelineno-0-16></a>        <span class=s1>'random'</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
<a href=#__codelineno-0-17 id=__codelineno-0-17 name=__codelineno-0-17></a>    <span class=p>},</span>
<a href=#__codelineno-0-18 id=__codelineno-0-18 name=__codelineno-0-18></a><span class=p>)</span>
<a href=#__codelineno-0-19 id=__codelineno-0-19 name=__codelineno-0-19></a><span class=n>df1</span> <span class=o>=</span> <span class=n>explode_date_range</span><span class=p>(</span>
<a href=#__codelineno-0-20 id=__codelineno-0-20 name=__codelineno-0-20></a>    <span class=n>df</span><span class=o>=</span><span class=n>d1</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>'start_date &lt; end_date'</span><span class=p>)</span><span class=o>.</span><span class=n>drop_duplicates</span><span class=p>(</span><span class=n>subset</span><span class=o>=</span><span class=p>[</span><span class=s1>'product_id'</span><span class=p>]),</span>
<a href=#__codelineno-0-21 id=__codelineno-0-21 name=__codelineno-0-21></a>    <span class=n>start_date_col</span><span class=o>=</span><span class=s1>'start_date'</span><span class=p>,</span>
<a href=#__codelineno-0-22 id=__codelineno-0-22 name=__codelineno-0-22></a>    <span class=n>end_date_col</span><span class=o>=</span><span class=s1>'end_date'</span><span class=p>,</span>
<a href=#__codelineno-0-23 id=__codelineno-0-23 name=__codelineno-0-23></a>    <span class=n>freq</span><span class=o>=</span><span class=s1>'D'</span><span class=p>,</span>
<a href=#__codelineno-0-24 id=__codelineno-0-24 name=__codelineno-0-24></a><span class=p>)</span>
</code></pre></div><p>Secondly, we create some sales forecast info for products that has actual sales data.<div class=highlight><pre><span></span><code><a href=#__codelineno-1-1 id=__codelineno-1-1 name=__codelineno-1-1></a><span class=n>d2</span> <span class=o>=</span> <span class=n>gen_rand_df</span><span class=p>(</span>
<a href=#__codelineno-1-2 id=__codelineno-1-2 name=__codelineno-1-2></a>    <span class=n>nrow</span><span class=o>=</span><span class=n>nrow</span><span class=p>,</span>
<a href=#__codelineno-1-3 id=__codelineno-1-3 name=__codelineno-1-3></a>    <span class=n>str_cols</span><span class=o>=</span><span class=p>{</span>
<a href=#__codelineno-1-4 id=__codelineno-1-4 name=__codelineno-1-4></a>        <span class=s1>'count'</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
<a href=#__codelineno-1-5 id=__codelineno-1-5 name=__codelineno-1-5></a>        <span class=s1>'name'</span><span class=p>:</span> <span class=s1>'product_id'</span><span class=p>,</span>
<a href=#__codelineno-1-6 id=__codelineno-1-6 name=__codelineno-1-6></a>        <span class=s1>'col_strs'</span><span class=p>:</span> <span class=n>d1</span><span class=p>[</span><span class=s1>'product_id'</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>(),</span>
<a href=#__codelineno-1-7 id=__codelineno-1-7 name=__codelineno-1-7></a>    <span class=p>},</span>
<a href=#__codelineno-1-8 id=__codelineno-1-8 name=__codelineno-1-8></a>    <span class=n>ts_cols</span><span class=o>=</span><span class=p>{</span>
<a href=#__codelineno-1-9 id=__codelineno-1-9 name=__codelineno-1-9></a>        <span class=s1>'count'</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
<a href=#__codelineno-1-10 id=__codelineno-1-10 name=__codelineno-1-10></a>        <span class=s1>'name'</span><span class=p>:</span> <span class=p>[</span><span class=s1>'start_date'</span><span class=p>,</span> <span class=s1>'end_date'</span><span class=p>],</span>
<a href=#__codelineno-1-11 id=__codelineno-1-11 name=__codelineno-1-11></a>        <span class=s1>'start_date'</span><span class=p>:</span> <span class=s1>'2025-01-01'</span><span class=p>,</span>
<a href=#__codelineno-1-12 id=__codelineno-1-12 name=__codelineno-1-12></a>        <span class=s1>'end_date'</span><span class=p>:</span> <span class=s1>'2035-01-01'</span><span class=p>,</span>
<a href=#__codelineno-1-13 id=__codelineno-1-13 name=__codelineno-1-13></a>        <span class=s1>'freq'</span><span class=p>:</span> <span class=s1>'D'</span><span class=p>,</span>
<a href=#__codelineno-1-14 id=__codelineno-1-14 name=__codelineno-1-14></a>        <span class=s1>'random'</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
<a href=#__codelineno-1-15 id=__codelineno-1-15 name=__codelineno-1-15></a>    <span class=p>},</span>
<a href=#__codelineno-1-16 id=__codelineno-1-16 name=__codelineno-1-16></a><span class=p>)</span>
<a href=#__codelineno-1-17 id=__codelineno-1-17 name=__codelineno-1-17></a><span class=n>df2</span> <span class=o>=</span> <span class=n>explode_date_range</span><span class=p>(</span>
<a href=#__codelineno-1-18 id=__codelineno-1-18 name=__codelineno-1-18></a>    <span class=n>df</span><span class=o>=</span><span class=n>d2</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>'start_date &lt; end_date'</span><span class=p>)</span><span class=o>.</span><span class=n>drop_duplicates</span><span class=p>(</span><span class=n>subset</span><span class=o>=</span><span class=p>[</span><span class=s1>'product_id'</span><span class=p>]),</span>
<a href=#__codelineno-1-19 id=__codelineno-1-19 name=__codelineno-1-19></a>    <span class=n>start_date_col</span><span class=o>=</span><span class=s1>'start_date'</span><span class=p>,</span>
<a href=#__codelineno-1-20 id=__codelineno-1-20 name=__codelineno-1-20></a>    <span class=n>end_date_col</span><span class=o>=</span><span class=s1>'end_date'</span><span class=p>,</span>
<a href=#__codelineno-1-21 id=__codelineno-1-21 name=__codelineno-1-21></a>    <span class=n>freq</span><span class=o>=</span><span class=s1>'D'</span><span class=p>,</span>
<a href=#__codelineno-1-22 id=__codelineno-1-22 name=__codelineno-1-22></a><span class=p>)</span>
</code></pre></div><p>Then, we create some dummy product sales revenue for both the actual and forecast records.<div class=highlight><pre><span></span><code><a href=#__codelineno-2-1 id=__codelineno-2-1 name=__codelineno-2-1></a><span class=n>d3</span> <span class=o>=</span> <span class=n>gen_rand_df</span><span class=p>(</span>
<a href=#__codelineno-2-2 id=__codelineno-2-2 name=__codelineno-2-2></a>    <span class=n>nrow</span><span class=o>=</span><span class=nb>max</span><span class=p>(</span><span class=n>df1</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>df2</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span>
<a href=#__codelineno-2-3 id=__codelineno-2-3 name=__codelineno-2-3></a>    <span class=n>float_cols</span><span class=o>=</span><span class=p>{</span>
<a href=#__codelineno-2-4 id=__codelineno-2-4 name=__codelineno-2-4></a>        <span class=s1>'count'</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
<a href=#__codelineno-2-5 id=__codelineno-2-5 name=__codelineno-2-5></a>        <span class=s1>'name'</span><span class=p>:</span> <span class=p>[</span><span class=s1>'daily_revenue1'</span><span class=p>,</span> <span class=s1>'daily_revenue2'</span><span class=p>],</span>
<a href=#__codelineno-2-6 id=__codelineno-2-6 name=__codelineno-2-6></a>        <span class=s1>'low'</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
<a href=#__codelineno-2-7 id=__codelineno-2-7 name=__codelineno-2-7></a>        <span class=s1>'high'</span><span class=p>:</span> <span class=mf>1e3</span><span class=p>,</span>
<a href=#__codelineno-2-8 id=__codelineno-2-8 name=__codelineno-2-8></a>        <span class=s1>'missing_pct'</span><span class=p>:</span> <span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span>
<a href=#__codelineno-2-9 id=__codelineno-2-9 name=__codelineno-2-9></a>    <span class=p>},</span>
<a href=#__codelineno-2-10 id=__codelineno-2-10 name=__codelineno-2-10></a><span class=p>)</span>
</code></pre></div><p>Finally, we add the sales revenue to the actual and forecast data.<div class=highlight><pre><span></span><code><a href=#__codelineno-3-1 id=__codelineno-3-1 name=__codelineno-3-1></a><span class=n>df_actual</span> <span class=o>=</span> <span class=p>(</span>
<a href=#__codelineno-3-2 id=__codelineno-3-2 name=__codelineno-3-2></a>    <span class=n>df1</span>
<a href=#__codelineno-3-3 id=__codelineno-3-3 name=__codelineno-3-3></a>    <span class=o>.</span><span class=n>assign</span><span class=p>(</span><span class=n>daily_revenue</span><span class=o>=</span><span class=n>d3</span><span class=p>[</span><span class=s1>'daily_revenue1'</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[:</span><span class=n>df1</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]])</span>
<a href=#__codelineno-3-4 id=__codelineno-3-4 name=__codelineno-3-4></a>    <span class=o>.</span><span class=n>set_index</span><span class=p>([</span><span class=s1>'product_id'</span><span class=p>,</span> <span class=s1>'daily_revenue'</span><span class=p>])</span>
<a href=#__codelineno-3-5 id=__codelineno-3-5 name=__codelineno-3-5></a><span class=p>)</span>
<a href=#__codelineno-3-6 id=__codelineno-3-6 name=__codelineno-3-6></a><span class=n>df_forecast</span> <span class=o>=</span> <span class=p>(</span>
<a href=#__codelineno-3-7 id=__codelineno-3-7 name=__codelineno-3-7></a>    <span class=n>df2</span>
<a href=#__codelineno-3-8 id=__codelineno-3-8 name=__codelineno-3-8></a>    <span class=o>.</span><span class=n>assign</span><span class=p>(</span><span class=n>daily_revenue</span><span class=o>=</span><span class=n>d3</span><span class=p>[</span><span class=s1>'daily_revenue2'</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>[:</span><span class=n>df2</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]])</span>
<a href=#__codelineno-3-9 id=__codelineno-3-9 name=__codelineno-3-9></a>    <span class=o>.</span><span class=n>set_index</span><span class=p>([</span><span class=s1>'product_id'</span><span class=p>,</span> <span class=s1>'daily_revenue'</span><span class=p>])</span>
<a href=#__codelineno-3-10 id=__codelineno-3-10 name=__codelineno-3-10></a><span class=p>)</span>
</code></pre></div><p>Here are the first few lines of the actual sales data:<div class=highlight><pre><span></span><code><a href=#__codelineno-4-1 id=__codelineno-4-1 name=__codelineno-4-1></a>                      daily_revenue
<a href=#__codelineno-4-2 id=__codelineno-4-2 name=__codelineno-4-2></a>product_id date
<a href=#__codelineno-4-3 id=__codelineno-4-3 name=__codelineno-4-3></a>P3hLcLj43u 2025-01-26    128.570203
<a href=#__codelineno-4-4 id=__codelineno-4-4 name=__codelineno-4-4></a>           2025-01-27    499.277862
<a href=#__codelineno-4-5 id=__codelineno-4-5 name=__codelineno-4-5></a>           2025-01-28    601.498358
</code></pre></div><h2 id=getting-last-consecutive-date>Getting last consecutive date<a title="Permanent link" class=headerlink href=#getting-last-consecutive-date>¶</a></h2><p>The function used to get the last consecutive date from a date series has been implemented as follows:<div class=highlight><pre><span></span><code><a href=#__codelineno-5-1 id=__codelineno-5-1 name=__codelineno-5-1></a><span class=k>def</span><span class=w> </span><span class=nf>get_last_consecutive_date</span><span class=p>(</span><span class=n>dates</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>)</span> <span class=o>-></span> <span class=n>np</span><span class=o>.</span><span class=n>datetime64</span> <span class=o>|</span> <span class=kc>None</span><span class=p>:</span>
<a href=#__codelineno-5-2 id=__codelineno-5-2 name=__codelineno-5-2></a>    <span class=c1># Empty input</span>
<a href=#__codelineno-5-3 id=__codelineno-5-3 name=__codelineno-5-3></a>    <span class=k>if</span> <span class=n>dates</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
<a href=#__codelineno-5-4 id=__codelineno-5-4 name=__codelineno-5-4></a>        <span class=k>return</span> <span class=kc>None</span>
<a href=#__codelineno-5-5 id=__codelineno-5-5 name=__codelineno-5-5></a>
<a href=#__codelineno-5-6 id=__codelineno-5-6 name=__codelineno-5-6></a>    <span class=n>dates</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>unique</span><span class=p>(</span><span class=n>dates</span><span class=p>)</span>
<a href=#__codelineno-5-7 id=__codelineno-5-7 name=__codelineno-5-7></a>
<a href=#__codelineno-5-8 id=__codelineno-5-8 name=__codelineno-5-8></a>    <span class=c1># Only one unique element in the list</span>
<a href=#__codelineno-5-9 id=__codelineno-5-9 name=__codelineno-5-9></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
<a href=#__codelineno-5-10 id=__codelineno-5-10 name=__codelineno-5-10></a>        <span class=k>return</span> <span class=n>dates</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<a href=#__codelineno-5-11 id=__codelineno-5-11 name=__codelineno-5-11></a>
<a href=#__codelineno-5-12 id=__codelineno-5-12 name=__codelineno-5-12></a>    <span class=n>diffs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>dates</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=s1>'timedelta64[D]'</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
<a href=#__codelineno-5-13 id=__codelineno-5-13 name=__codelineno-5-13></a>    <span class=n>last_consecutive_day_index</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>diffs</span> <span class=o>></span> <span class=mi>1</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
<a href=#__codelineno-5-14 id=__codelineno-5-14 name=__codelineno-5-14></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>last_consecutive_day_index</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
<a href=#__codelineno-5-15 id=__codelineno-5-15 name=__codelineno-5-15></a>        <span class=k>return</span> <span class=n>dates</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=c1># all dates are consecutive</span>
<a href=#__codelineno-5-16 id=__codelineno-5-16 name=__codelineno-5-16></a>    <span class=k>else</span><span class=p>:</span>
<a href=#__codelineno-5-17 id=__codelineno-5-17 name=__codelineno-5-17></a>        <span class=k>return</span> <span class=n>dates</span><span class=p>[</span><span class=n>last_consecutive_day_index</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span>
</code></pre></div><h2 id=using-pandas-dfgroupbyapply>Using Pandas <code>df.groupby.apply</code><a title="Permanent link" class=headerlink href=#using-pandas-dfgroupbyapply>¶</a></h2><p>As we have to perform the same task for each group of products, naturally we can use Pandas <code>df.groupby.apply</code>. But this function generally only works for one DataFrame. Here we have two DataFrames and one option is passing the second DataFrame as a parameter.<p>Here is the implementation:<div class=highlight><pre><span></span><code><a href=#__codelineno-6-1 id=__codelineno-6-1 name=__codelineno-6-1></a><span class=k>def</span><span class=w> </span><span class=nf>keep_records_after_consecutive_dates_v1</span><span class=p>(</span>
<a href=#__codelineno-6-2 id=__codelineno-6-2 name=__codelineno-6-2></a>    <span class=n>df_forecast</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
<a href=#__codelineno-6-3 id=__codelineno-6-3 name=__codelineno-6-3></a>    <span class=n>df_actual</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
<a href=#__codelineno-6-4 id=__codelineno-6-4 name=__codelineno-6-4></a><span class=p>)</span> <span class=o>-></span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<a href=#__codelineno-6-5 id=__codelineno-6-5 name=__codelineno-6-5></a>    <span class=n>product_id</span> <span class=o>=</span> <span class=n>df_forecast</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=n>df_forecast</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>names</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s1>'product_id'</span><span class=p>)]</span>
<a href=#__codelineno-6-6 id=__codelineno-6-6 name=__codelineno-6-6></a>    <span class=n>dates</span> <span class=o>=</span> <span class=n>df_actual</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>'product_id == @product_id & daily_revenue.notna()'</span><span class=p>)</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>unique</span><span class=p>(</span><span class=s1>'date'</span><span class=p>)</span>
<a href=#__codelineno-6-7 id=__codelineno-6-7 name=__codelineno-6-7></a>    <span class=c1># Get last consecutive date and filter df_forecast</span>
<a href=#__codelineno-6-8 id=__codelineno-6-8 name=__codelineno-6-8></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)</span> <span class=o>></span> <span class=mi>0</span><span class=p>:</span>
<a href=#__codelineno-6-9 id=__codelineno-6-9 name=__codelineno-6-9></a>        <span class=n>last_consecutive_date</span> <span class=o>=</span> <span class=n>get_last_consecutive_date</span><span class=p>(</span><span class=n>dates</span><span class=p>)</span>
<a href=#__codelineno-6-10 id=__codelineno-6-10 name=__codelineno-6-10></a>        <span class=n>df_forecast</span> <span class=o>=</span> <span class=n>df_forecast</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>'date > @last_consecutive_date'</span><span class=p>)</span>
<a href=#__codelineno-6-11 id=__codelineno-6-11 name=__codelineno-6-11></a>    <span class=k>return</span> <span class=n>df_forecast</span>
<a href=#__codelineno-6-12 id=__codelineno-6-12 name=__codelineno-6-12></a>
<a href=#__codelineno-6-13 id=__codelineno-6-13 name=__codelineno-6-13></a><span class=n>df_v1</span> <span class=o>=</span> <span class=p>(</span>
<a href=#__codelineno-6-14 id=__codelineno-6-14 name=__codelineno-6-14></a>    <span class=n>df_forecast</span>
<a href=#__codelineno-6-15 id=__codelineno-6-15 name=__codelineno-6-15></a>    <span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>'product_id'</span><span class=p>,</span> <span class=n>group_keys</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<a href=#__codelineno-6-16 id=__codelineno-6-16 name=__codelineno-6-16></a>    <span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>keep_records_after_consecutive_dates_v1</span><span class=p>,</span> <span class=n>df_actual</span><span class=p>)</span>
<a href=#__codelineno-6-17 id=__codelineno-6-17 name=__codelineno-6-17></a><span class=p>)</span>
</code></pre></div> The run time is <strong>327 seconds</strong>. <h2 id=avoiding-repeated-query-and-filtering>Avoiding repeated query and filtering<a title="Permanent link" class=headerlink href=#avoiding-repeated-query-and-filtering>¶</a></h2><p>By checking the previous implementation, we can observe that we have a repeated query and filtering for each product on the actual sales DataFrame. That is likely to slow down the process.<p>Now we do the query for all products and group the product records in advance. Hopefully this will make it much faster.<p>Here is the updated version:<div class=highlight><pre><span></span><code><a href=#__codelineno-7-1 id=__codelineno-7-1 name=__codelineno-7-1></a><span class=k>def</span><span class=w> </span><span class=nf>keep_records_after_consecutive_dates_v2</span><span class=p>(</span>
<a href=#__codelineno-7-2 id=__codelineno-7-2 name=__codelineno-7-2></a>    <span class=n>df_forecast</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
<a href=#__codelineno-7-3 id=__codelineno-7-3 name=__codelineno-7-3></a>    <span class=n>df_actual</span><span class=p>:</span> <span class=n>DataFrameGroupBy</span><span class=p>,</span>
<a href=#__codelineno-7-4 id=__codelineno-7-4 name=__codelineno-7-4></a><span class=p>)</span> <span class=o>-></span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<a href=#__codelineno-7-5 id=__codelineno-7-5 name=__codelineno-7-5></a>    <span class=n>product_id</span> <span class=o>=</span> <span class=n>df_forecast</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=n>df_forecast</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>names</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=s1>'product_id'</span><span class=p>)]</span>
<a href=#__codelineno-7-6 id=__codelineno-7-6 name=__codelineno-7-6></a>    <span class=k>if</span> <span class=n>product_id</span> <span class=ow>in</span> <span class=n>df_actual</span><span class=o>.</span><span class=n>groups</span><span class=p>:</span>
<a href=#__codelineno-7-7 id=__codelineno-7-7 name=__codelineno-7-7></a>        <span class=n>dates</span> <span class=o>=</span> <span class=n>df_actual</span><span class=o>.</span><span class=n>get_group</span><span class=p>(</span><span class=n>product_id</span><span class=p>)</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>unique</span><span class=p>(</span><span class=s1>'date'</span><span class=p>)</span>
<a href=#__codelineno-7-8 id=__codelineno-7-8 name=__codelineno-7-8></a>        <span class=c1># Get last consecutive date and filter df_forecast</span>
<a href=#__codelineno-7-9 id=__codelineno-7-9 name=__codelineno-7-9></a>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)</span> <span class=o>></span> <span class=mi>0</span><span class=p>:</span>
<a href=#__codelineno-7-10 id=__codelineno-7-10 name=__codelineno-7-10></a>            <span class=n>last_consecutive_date</span> <span class=o>=</span> <span class=n>get_last_consecutive_datex</span><span class=p>(</span><span class=n>dates</span><span class=p>)</span>
<a href=#__codelineno-7-11 id=__codelineno-7-11 name=__codelineno-7-11></a>            <span class=n>df_forecast</span> <span class=o>=</span> <span class=n>df_forecast</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>'date > @last_consecutive_date'</span><span class=p>)</span>
<a href=#__codelineno-7-12 id=__codelineno-7-12 name=__codelineno-7-12></a>    <span class=k>return</span> <span class=n>df_forecast</span>
<a href=#__codelineno-7-13 id=__codelineno-7-13 name=__codelineno-7-13></a>
<a href=#__codelineno-7-14 id=__codelineno-7-14 name=__codelineno-7-14></a><span class=n>grp_actual</span> <span class=o>=</span> <span class=n>df_actual</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>'daily_revenue.notna()'</span><span class=p>)</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>'product_id'</span><span class=p>)</span>
<a href=#__codelineno-7-15 id=__codelineno-7-15 name=__codelineno-7-15></a><span class=n>df_v2</span> <span class=o>=</span> <span class=p>(</span>
<a href=#__codelineno-7-16 id=__codelineno-7-16 name=__codelineno-7-16></a>    <span class=n>df_forecast</span>
<a href=#__codelineno-7-17 id=__codelineno-7-17 name=__codelineno-7-17></a>    <span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>'product_id'</span><span class=p>,</span> <span class=n>group_keys</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<a href=#__codelineno-7-18 id=__codelineno-7-18 name=__codelineno-7-18></a>    <span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>keep_records_after_consecutive_dates_v2</span><span class=p>,</span> <span class=n>grp_actual</span><span class=p>)</span>
<a href=#__codelineno-7-19 id=__codelineno-7-19 name=__codelineno-7-19></a><span class=p>)</span>
</code></pre></div> Now the run time is <strong>17.6 seconds</strong> --- that's about <strong>18x</strong> faster. <h2 id=using-a-python-for-loop>Using a Python for-loop<a title="Permanent link" class=headerlink href=#using-a-python-for-loop>¶</a></h2><p>The <code>.apply()</code> often has some overhead compared to a pure Python for-loop. We now replace the <code>.apply()</code> with a for-loop. At the same time we can remove the index parsing for all product groups.<div class=highlight><pre><span></span><code><a href=#__codelineno-8-1 id=__codelineno-8-1 name=__codelineno-8-1></a><span class=k>def</span><span class=w> </span><span class=nf>keep_records_after_consecutive_dates_v3</span><span class=p>(</span>
<a href=#__codelineno-8-2 id=__codelineno-8-2 name=__codelineno-8-2></a>    <span class=n>df_forecast</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
<a href=#__codelineno-8-3 id=__codelineno-8-3 name=__codelineno-8-3></a>    <span class=n>df_actual</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
<a href=#__codelineno-8-4 id=__codelineno-8-4 name=__codelineno-8-4></a><span class=p>)</span> <span class=o>-></span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<a href=#__codelineno-8-5 id=__codelineno-8-5 name=__codelineno-8-5></a>    <span class=n>dates</span> <span class=o>=</span> <span class=n>df_actual</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>unique</span><span class=p>(</span><span class=s1>'date'</span><span class=p>)</span>
<a href=#__codelineno-8-6 id=__codelineno-8-6 name=__codelineno-8-6></a>    <span class=c1># Get last consecutive date and filter df_forecast</span>
<a href=#__codelineno-8-7 id=__codelineno-8-7 name=__codelineno-8-7></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>dates</span><span class=p>)</span> <span class=o>></span> <span class=mi>0</span><span class=p>:</span>
<a href=#__codelineno-8-8 id=__codelineno-8-8 name=__codelineno-8-8></a>        <span class=n>last_consecutive_date</span> <span class=o>=</span> <span class=n>get_last_consecutive_datex</span><span class=p>(</span><span class=n>dates</span><span class=p>)</span>
<a href=#__codelineno-8-9 id=__codelineno-8-9 name=__codelineno-8-9></a>        <span class=n>df_forecast</span> <span class=o>=</span> <span class=n>df_forecast</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>'date > @last_consecutive_date'</span><span class=p>)</span>
<a href=#__codelineno-8-10 id=__codelineno-8-10 name=__codelineno-8-10></a>    <span class=k>return</span> <span class=n>df_forecast</span>
<a href=#__codelineno-8-11 id=__codelineno-8-11 name=__codelineno-8-11></a>
<a href=#__codelineno-8-12 id=__codelineno-8-12 name=__codelineno-8-12></a><span class=n>dfs</span> <span class=o>=</span> <span class=p>[]</span>
<a href=#__codelineno-8-13 id=__codelineno-8-13 name=__codelineno-8-13></a><span class=n>grp_actual</span> <span class=o>=</span> <span class=n>df_actual</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>'daily_revenue.notna()'</span><span class=p>)</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>'product_id'</span><span class=p>)</span>
<a href=#__codelineno-8-14 id=__codelineno-8-14 name=__codelineno-8-14></a><span class=n>grp_forecast</span> <span class=o>=</span> <span class=n>df_forecast</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>'product_id'</span><span class=p>)</span>
<a href=#__codelineno-8-15 id=__codelineno-8-15 name=__codelineno-8-15></a><span class=n>product_ids</span> <span class=o>=</span> <span class=n>df_forecast</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>unique</span><span class=p>(</span><span class=s1>'product_id'</span><span class=p>)</span>
<a href=#__codelineno-8-16 id=__codelineno-8-16 name=__codelineno-8-16></a><span class=k>for</span> <span class=n>product_id</span> <span class=ow>in</span> <span class=n>product_ids</span><span class=p>:</span>
<a href=#__codelineno-8-17 id=__codelineno-8-17 name=__codelineno-8-17></a>    <span class=k>if</span> <span class=n>product_id</span> <span class=ow>in</span> <span class=n>grp_actual</span><span class=o>.</span><span class=n>groups</span><span class=p>:</span>
<a href=#__codelineno-8-18 id=__codelineno-8-18 name=__codelineno-8-18></a>        <span class=n>df</span> <span class=o>=</span> <span class=n>keep_records_after_consecutive_dates_v3</span><span class=p>(</span>
<a href=#__codelineno-8-19 id=__codelineno-8-19 name=__codelineno-8-19></a>            <span class=n>grp_forecast</span><span class=o>.</span><span class=n>get_group</span><span class=p>(</span><span class=n>product_id</span><span class=p>),</span>
<a href=#__codelineno-8-20 id=__codelineno-8-20 name=__codelineno-8-20></a>            <span class=n>grp_actual</span><span class=o>.</span><span class=n>get_group</span><span class=p>(</span><span class=n>product_id</span><span class=p>),</span>
<a href=#__codelineno-8-21 id=__codelineno-8-21 name=__codelineno-8-21></a>        <span class=p>)</span>
<a href=#__codelineno-8-22 id=__codelineno-8-22 name=__codelineno-8-22></a>    <span class=k>else</span><span class=p>:</span>
<a href=#__codelineno-8-23 id=__codelineno-8-23 name=__codelineno-8-23></a>        <span class=n>df</span> <span class=o>=</span> <span class=n>grp_forecast</span><span class=o>.</span><span class=n>get_group</span><span class=p>(</span><span class=n>product_id</span><span class=p>)</span>
<a href=#__codelineno-8-24 id=__codelineno-8-24 name=__codelineno-8-24></a>    <span class=n>dfs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
<a href=#__codelineno-8-25 id=__codelineno-8-25 name=__codelineno-8-25></a><span class=n>df_v3</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>dfs</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</code></pre></div> The run time is <strong>9.8 seconds</strong> --- that's about <strong>1.8x</strong> faster than version #2. <h2 id=vectorized-process-without-for-loop>Vectorized process without for-loop<a title="Permanent link" class=headerlink href=#vectorized-process-without-for-loop>¶</a></h2><p>It's obvious that we can vectorize the calculation of the last consecutive date for all products. Pandas <code>groupby().apply()</code> on a Series can be very efficient, as it often operates on NumPy arrays internally.<p>We can also avoid the for-loop by using vectorized join and filtering operations. By doing that we don't need to join small DataFrames for all products using <code>pd.concat</code>.<p>The final optimized version is showing as follows:<div class=highlight><pre><span></span><code><a href=#__codelineno-9-1 id=__codelineno-9-1 name=__codelineno-9-1></a><span class=k>def</span><span class=w> </span><span class=nf>keep_records_after_consecutive_dates_v4</span><span class=p>(</span>
<a href=#__codelineno-9-2 id=__codelineno-9-2 name=__codelineno-9-2></a>    <span class=n>df_forecast</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
<a href=#__codelineno-9-3 id=__codelineno-9-3 name=__codelineno-9-3></a>    <span class=n>df_actual</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>,</span>
<a href=#__codelineno-9-4 id=__codelineno-9-4 name=__codelineno-9-4></a><span class=p>)</span> <span class=o>-></span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>:</span>
<a href=#__codelineno-9-5 id=__codelineno-9-5 name=__codelineno-9-5></a>    <span class=c1># Get last consecutive date for each product</span>
<a href=#__codelineno-9-6 id=__codelineno-9-6 name=__codelineno-9-6></a>    <span class=n>last_consecutive_dates</span> <span class=o>=</span> <span class=p>(</span>
<a href=#__codelineno-9-7 id=__codelineno-9-7 name=__codelineno-9-7></a>        <span class=n>df_actual</span>
<a href=#__codelineno-9-8 id=__codelineno-9-8 name=__codelineno-9-8></a>        <span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>'daily_revenue.notna()'</span><span class=p>)</span>
<a href=#__codelineno-9-9 id=__codelineno-9-9 name=__codelineno-9-9></a>        <span class=o>.</span><span class=n>reset_index</span><span class=p>(</span><span class=s1>'date'</span><span class=p>)</span>
<a href=#__codelineno-9-10 id=__codelineno-9-10 name=__codelineno-9-10></a>        <span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>'product_id'</span><span class=p>)[</span><span class=s1>'date'</span><span class=p>]</span>
<a href=#__codelineno-9-11 id=__codelineno-9-11 name=__codelineno-9-11></a>        <span class=o>.</span><span class=n>apply</span><span class=p>(</span><span class=n>get_last_consecutive_date</span><span class=p>)</span>
<a href=#__codelineno-9-12 id=__codelineno-9-12 name=__codelineno-9-12></a>        <span class=o>.</span><span class=n>to_frame</span><span class=p>()</span>
<a href=#__codelineno-9-13 id=__codelineno-9-13 name=__codelineno-9-13></a>        <span class=o>.</span><span class=n>rename</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=p>{</span><span class=s1>'date'</span><span class=p>:</span> <span class=s1>'last_consecutive_date'</span><span class=p>})</span>
<a href=#__codelineno-9-14 id=__codelineno-9-14 name=__codelineno-9-14></a>    <span class=p>)</span>
<a href=#__codelineno-9-15 id=__codelineno-9-15 name=__codelineno-9-15></a>    <span class=c1># Filter df_forecast</span>
<a href=#__codelineno-9-16 id=__codelineno-9-16 name=__codelineno-9-16></a>    <span class=n>df_forecast</span> <span class=o>=</span> <span class=p>(</span>
<a href=#__codelineno-9-17 id=__codelineno-9-17 name=__codelineno-9-17></a>        <span class=n>df_forecast</span>
<a href=#__codelineno-9-18 id=__codelineno-9-18 name=__codelineno-9-18></a>        <span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>last_consecutive_dates</span><span class=p>,</span> <span class=n>on</span><span class=o>=</span><span class=s1>'product_id'</span><span class=p>,</span> <span class=n>how</span><span class=o>=</span><span class=s1>'left'</span><span class=p>)</span>
<a href=#__codelineno-9-19 id=__codelineno-9-19 name=__codelineno-9-19></a>        <span class=o>.</span><span class=n>fillna</span><span class=p>({</span><span class=s1>'last_consecutive_date'</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>Timestamp</span><span class=o>.</span><span class=n>min</span><span class=p>})</span>
<a href=#__codelineno-9-20 id=__codelineno-9-20 name=__codelineno-9-20></a>        <span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s1>'date > last_consecutive_date'</span><span class=p>)</span>
<a href=#__codelineno-9-21 id=__codelineno-9-21 name=__codelineno-9-21></a>        <span class=o>.</span><span class=n>drop</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=s1>'last_consecutive_date'</span><span class=p>)</span>
<a href=#__codelineno-9-22 id=__codelineno-9-22 name=__codelineno-9-22></a>    <span class=p>)</span>
<a href=#__codelineno-9-23 id=__codelineno-9-23 name=__codelineno-9-23></a>    <span class=k>return</span> <span class=n>df_forecast</span>
<a href=#__codelineno-9-24 id=__codelineno-9-24 name=__codelineno-9-24></a>
<a href=#__codelineno-9-25 id=__codelineno-9-25 name=__codelineno-9-25></a><span class=n>df_v4</span> <span class=o>=</span> <span class=n>keep_records_after_consecutive_dates_v4</span><span class=p>(</span><span class=n>df_forecast</span><span class=p>,</span> <span class=n>df_actual</span><span class=p>)</span>
</code></pre></div> The final run time is <strong>2.4 seconds</strong> - that's about <strong>4x</strong> faster than version #3 and about <strong>130x</strong> faster than the original version #1 (<strong>327 seconds</strong>). <h2 id=summary>summary<a title="Permanent link" class=headerlink href=#summary>¶</a></h2><p>By avoiding repeated query and filtering operations and vectorization of some other operations, I successfully made a Python process running 130x faster. I also did some similar optimization for extracting forecast data from a database. Ultimately the application total execution time was reduced from over two hours to less than 20 seconds.<p>Want to know more tips about coding and other things, please visit: https://github.com/seanslma/maki</article></div><script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script></div><button class="md-top md-icon" data-md-component=top hidden type=button><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top</button></main><footer class=md-footer><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright><div class=md-copyright__highlight><a title="Go to Main Home Page" href=/>🏠 Back to Home</a><br> Copyright © 2026 Sean Ma <br>Last updated on 17 Jan 2026</div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ rel=noopener target=_blank> Material for MkDocs </a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.expand", "navigation.indexes", "navigation.top", "toc.follow", "search.suggest", "search.highlight", "content.code.copy", "navigation.prune"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script><script src=../../../assets/javascripts/bundle.56ea9cef.min.js></script>