<!doctype html><html class=no-js lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://seanslma.github.io/maki/Python/Blog/NumbaPerf/ rel=canonical><link href=../GroupbyApplyPerf/ rel=prev><link href=../PackageManagement/ rel=next><link href=../../../assets/images/favicon.png rel=icon><meta content="mkdocs-1.6.1, mkdocs-material-9.6.15" name=generator><title>Make Python Loops 5x to 10x Faster Using Numba - maki</title><link href=../../../assets/stylesheets/main.342714a4.min.css rel=stylesheet><link href=../../../assets/stylesheets/palette.06af60db.min.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback" rel=stylesheet><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link href=../../../stylesheets/extra.css rel=stylesheet><script>__md_scope=new URL(`../../..`,location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+`.`+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+`.`+e,JSON.stringify(_))}catch{}};</script><body data-md-color-accent=indigo data-md-color-primary=indigo data-md-color-scheme=default dir=ltr><input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox><input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox><label class=md-overlay for=__drawer></label><div data-md-component=skip><a class=md-skip href=#make-python-loops-5x-to-10x-faster-using-numba> Skip to content </a></div><div data-md-component=announce></div><header class=md-header data-md-component=header><nav class="md-header__inner md-grid" aria-label=Header><a class="md-header__button md-logo" aria-label=maki data-md-component=logo href=../../.. title=maki> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a><label class="md-header__button md-icon" for=__drawer><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></label><div class=md-header__title data-md-component=header-title><div class=md-header__ellipsis><div class=md-header__topic><span class=md-ellipsis> maki </span></div><div class=md-header__topic data-md-component=header-topic><span class=md-ellipsis> Make Python Loops 5x to 10x Faster Using Numba </span></div></div></div><form class=md-header__option data-md-component=palette><input aria-label="Switch to dark mode" class=md-option data-md-color-accent=indigo data-md-color-media data-md-color-primary=indigo data-md-color-scheme=default id=__palette_0 name=__palette type=radio><label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label><input aria-label="Switch to light mode" class=md-option data-md-color-accent=indigo data-md-color-media data-md-color-primary=indigo data-md-color-scheme=slate id=__palette_1 name=__palette type=radio><label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg></label></form><script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script><label class="md-header__button md-icon" for=__search><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg></label><div class=md-search data-md-component=search role=dialog><label class=md-search__overlay for=__search></label><div class=md-search__inner role=search><form class=md-search__form name=search><input aria-label=Search autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query placeholder=Search required spellcheck=false><label class="md-search__icon md-icon" for=__search><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg></label><nav aria-label=Search class=md-search__options><button class="md-search__icon md-icon" aria-label=Clear tabindex=-1 title=Clear type=reset><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></nav><div class=md-search__suggest data-md-component=search-suggest></div></form><div class=md-search__output><div class=md-search__scrollwrap data-md-scrollfix tabindex=0><div class=md-search-result data-md-component=search-result><div class=md-search-result__meta>Initializing search</div><ol class=md-search-result__list role=presentation></ol></div></div></div></div></div><div class=md-header__source><a title="Go to repository" class=md-source data-md-component=source href=https://github.com/seanslma/maki> <div class="md-source__icon md-icon"><svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg></div> <div class=md-source__repository>GitHub</div> </a></div></nav></header><div class=md-container data-md-component=container><nav aria-label=Tabs class=md-tabs data-md-component=tabs><div class=md-grid><ul class=md-tabs__list><li class=md-tabs__item><a class=md-tabs__link href=../../..> About </a><li class=md-tabs__item><a class=md-tabs__link href=../../../AI/ChatGPT/> AI </a><li class=md-tabs__item><a class=md-tabs__link href=../../../AWS/CDN/> AWS </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Azure/Advisor/> Azure </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Coding/Notepad%2B%2B/> Coding </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Cybersecurity/Cybersecurity/> Cybersecurity </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Data/Data/> Data </a><li class=md-tabs__item><a class=md-tabs__link href=../../../DevOps/DevOps/> DevOps </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Documentation/Jira/> Documentation </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Energy/Inertia/> Energy </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Learn/Book/> Learn </a><li class=md-tabs__item><a class=md-tabs__link href=../../../ML/Backtest/> ML </a><li class=md-tabs__item><a class=md-tabs__link href=../../../Optimizaton/Convex/> Optimizaton </a><li class=md-tabs__item><a class=md-tabs__link href=../../../PowerBI/Basic/> PowerBI </a><li class="md-tabs__item md-tabs__item--active"><a class=md-tabs__link href=../../Basic/> Python </a><li class=md-tabs__item><a class=md-tabs__link href=../../../SQL/Database/> SQL </a><li class=md-tabs__item><a class=md-tabs__link href=../../../System/Behavior/> System </a></ul></div></nav><main class=md-main data-md-component=main><div class="md-main__inner md-grid"><div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0><label class=md-nav__title for=__drawer><a class="md-nav__button md-logo" aria-label=maki data-md-component=logo href=../../.. title=maki> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> maki</label><div class=md-nav__source><a title="Go to repository" class=md-source data-md-component=source href=https://github.com/seanslma/maki> <div class="md-source__icon md-icon"><svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg></div> <div class=md-source__repository>GitHub</div> </a></div><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../../..> <span class=md-ellipsis> About </span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../AI/ChatGPT/> <span class=md-ellipsis> AI </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../AWS/CDN/> <span class=md-ellipsis> AWS </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Azure/Advisor/> <span class=md-ellipsis> Azure </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Coding/Notepad%2B%2B/> <span class=md-ellipsis> Coding </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Cybersecurity/Cybersecurity/> <span class=md-ellipsis> Cybersecurity </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Data/Data/> <span class=md-ellipsis> Data </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../DevOps/DevOps/> <span class=md-ellipsis> DevOps </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Documentation/Jira/> <span class=md-ellipsis> Documentation </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Energy/Inertia/> <span class=md-ellipsis> Energy </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Learn/Book/> <span class=md-ellipsis> Learn </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../ML/Backtest/> <span class=md-ellipsis> ML </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../Optimizaton/Convex/> <span class=md-ellipsis> Optimizaton </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../PowerBI/Basic/> <span class=md-ellipsis> PowerBI </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"><input class="md-nav__toggle md-toggle" checked id=__nav_15 type=checkbox> <label class=md-nav__link for=__nav_15 id=__nav_15_label><span class=md-ellipsis> Python </span> <span class="md-nav__icon md-icon"></span></label> <nav aria-expanded=true aria-labelledby=__nav_15_label class=md-nav data-md-level=1><label class=md-nav__title for=__nav_15><span class="md-nav__icon md-icon"></span> Python</label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../../Basic/> <span class=md-ellipsis> Basic </span> </a><li class=md-nav__item><a class=md-nav__link href=../../NaN/> <span class=md-ellipsis> NaN </span> </a><li class=md-nav__item><a class=md-nav__link href=../../Python/> <span class=md-ellipsis> Python </span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../API/API/> <span class=md-ellipsis> API </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../App/Module/> <span class=md-ellipsis> App </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Architect/Decorator/> <span class=md-ellipsis> Architect </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Async/Asyncio/> <span class=md-ellipsis> Async </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--active md-nav__item--nested"><input class="md-nav__toggle md-toggle" checked id=__nav_15_8 type=checkbox> <label class=md-nav__link for=__nav_15_8 id=__nav_15_8_label tabindex=0><span class=md-ellipsis> Blog </span> <span class="md-nav__icon md-icon"></span></label> <nav aria-expanded=true aria-labelledby=__nav_15_8_label class=md-nav data-md-level=2><label class=md-nav__title for=__nav_15_8><span class="md-nav__icon md-icon"></span> Blog</label><ul class=md-nav__list data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=../BestPractices/> <span class=md-ellipsis> Python Programing Best Practice </span> </a><li class=md-nav__item><a class=md-nav__link href=../CachesinPython/> <span class=md-ellipsis> Caches used in Python </span> </a><li class=md-nav__item><a class=md-nav__link href=../GroupbyApplyPerf/> <span class=md-ellipsis> How I reduced a Python app run time from two hours to 20 seconds? </span> </a><li class="md-nav__item md-nav__item--active"><input class="md-nav__toggle md-toggle" id=__toc type=checkbox> <label class="md-nav__link md-nav__link--active" for=__toc><span class=md-ellipsis> Make Python Loops 5x to 10x Faster Using Numba </span> <span class="md-nav__icon md-icon"></span></label> <a class="md-nav__link md-nav__link--active" href=./> <span class=md-ellipsis> Make Python Loops 5x to 10x Faster Using Numba </span> </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> Table of contents</label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=#key-features-of-numba> <span class=md-ellipsis> Key features of numba </span> </a><li class=md-nav__item><a class=md-nav__link href=#when-to-use-and-to-avoid-numba> <span class=md-ellipsis> When to use and to avoid numba </span> </a><li class=md-nav__item><a class=md-nav__link href=#data-for-testing-demonstration> <span class=md-ellipsis> Data for testing demonstration </span> </a><li class=md-nav__item><a class=md-nav__link href=#initial-version> <span class=md-ellipsis> Initial version </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-numpy-function> <span class=md-ellipsis> Using numpy function </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-numbanjit> <span class=md-ellipsis> Using numba.njit </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-numbanjit-with-data-types> <span class=md-ellipsis> Using numba.njit with data types </span> </a><li class=md-nav__item><a class=md-nav__link href=#replacing-numpy-function-with-a-python-loop> <span class=md-ellipsis> Replacing numpy function with a python loop </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-numbanjit-parallel-mode> <span class=md-ellipsis> Using numba.njit parallel mode </span> </a><li class=md-nav__item><a class=md-nav__link href=#references> <span class=md-ellipsis> References </span> </a></ul></nav><li class=md-nav__item><a class=md-nav__link href=../PackageManagement/> <span class=md-ellipsis> How to manage python package dependencies </span> </a><li class=md-nav__item><a class=md-nav__link href=../PandasExplodeDateRange/> <span class=md-ellipsis> How to explode date ranges in a Pandas DataFrame 30x faster </span> </a><li class=md-nav__item><a class=md-nav__link href=../PandasTestDataFrame/> <span class=md-ellipsis> How to create dummy Pandas DataFrames for testing </span> </a><li class=md-nav__item><a class=md-nav__link href=../ReadCSVPerf/> <span class=md-ellipsis> Read CSV Files 10x to 40x Faster Using pyarrow and polars </span> </a><li class=md-nav__item><a class=md-nav__link href=../ReadExcelPerf/> <span class=md-ellipsis> Read Excel performance </span> </a><li class=md-nav__item><a class=md-nav__link href=../ReadParquetPerf/> <span class=md-ellipsis> Read parquet performance </span> </a><li class=md-nav__item><a class=md-nav__link href=../ReadSqlDataType/> <span class=md-ellipsis> The Pandas Function pd.read_sql Returns An Empty DataFrame Without Correct Data Types </span> </a><li class=md-nav__item><a class=md-nav__link href=../SqlSslSecurityLevel/> <span class=md-ellipsis> Login Timeout From Ubuntu 22.04 To SQL Server Database </span> </a></ul></nav><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../CLI/Click/> <span class=md-ellipsis> CLI </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Cache/Aiocache/> <span class=md-ellipsis> Cache </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Celery/Example/> <span class=md-ellipsis> Celery </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Class/ClassMethod/> <span class=md-ellipsis> Class </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Conda/Bashrc/> <span class=md-ellipsis> Conda </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Dash/Callback/> <span class=md-ellipsis> Dash </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Dask/Config/> <span class=md-ellipsis> Dask </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../DataType/Dictionary/> <span class=md-ellipsis> DataType </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../DateTime/Conversion/> <span class=md-ellipsis> DateTime </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Django/Django/> <span class=md-ellipsis> Django </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Email/ExchangeLib/> <span class=md-ellipsis> Email </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Env/Env/> <span class=md-ellipsis> Env </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../ErrorHandling/Exception/> <span class=md-ellipsis> ErrorHandling </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Excel/Excel/> <span class=md-ellipsis> Excel </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Flask/Request/> <span class=md-ellipsis> Flask </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Format/Black/> <span class=md-ellipsis> Format </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Generator/Generator/> <span class=md-ellipsis> Generator </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../IO/AzureBlob/> <span class=md-ellipsis> IO </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Issue/Main/> <span class=md-ellipsis> Issue </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Jupyter/Dashboard/> <span class=md-ellipsis> Jupyter </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Logging/AzureLibraries/> <span class=md-ellipsis> Logging </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../MSOffice/Access/> <span class=md-ellipsis> MSOffice </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Math/Sparse/> <span class=md-ellipsis> Math </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../NumPy/CSmooth/> <span class=md-ellipsis> NumPy </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Package/CondaBuild/> <span class=md-ellipsis> Package </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Pandas/Advance/> <span class=md-ellipsis> Pandas </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../PandasUpgradeTest/Datetime/> <span class=md-ellipsis> PandasUpgradeTest </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Parallel/Example/> <span class=md-ellipsis> Parallel </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Performance/Deadlock/> <span class=md-ellipsis> Performance </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Pip/Pip/> <span class=md-ellipsis> Pip </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Polars/CSV/> <span class=md-ellipsis> Polars </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../PyArrow/CSV/> <span class=md-ellipsis> PyArrow </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../PySpark/Column/> <span class=md-ellipsis> PySpark </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Pytorch/Install/> <span class=md-ellipsis> Pytorch </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Regex/Regex/> <span class=md-ellipsis> Regex </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../SQL/ADBC/> <span class=md-ellipsis> SQL </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../SQLAlchemy/BindParam/> <span class=md-ellipsis> SQLAlchemy </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../SSL/Cert/> <span class=md-ellipsis> SSL </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../SciPy/SparseMatrix/> <span class=md-ellipsis> SciPy </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Serialization/Benchmark/> <span class=md-ellipsis> Serialization </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Tensorflow/Install/> <span class=md-ellipsis> Tensorflow </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Test/Caplog/> <span class=md-ellipsis> Test </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Typing/Tips/> <span class=md-ellipsis> Typing </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Visualization/Chart/> <span class=md-ellipsis> Visualization </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../Web/Cherrypy/> <span class=md-ellipsis> Web </span> <span class="md-nav__icon md-icon"></span> </a></ul></nav><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../SQL/Database/> <span class=md-ellipsis> SQL </span> <span class="md-nav__icon md-icon"></span> </a><li class="md-nav__item md-nav__item--pruned md-nav__item--nested"><a class=md-nav__link href=../../../System/Behavior/> <span class=md-ellipsis> System </span> <span class="md-nav__icon md-icon"></span> </a></ul></nav></div></div></div><div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc><div class=md-sidebar__scrollwrap><div class=md-sidebar__inner><nav aria-label="Table of contents" class="md-nav md-nav--secondary"><label class=md-nav__title for=__toc><span class="md-nav__icon md-icon"></span> Table of contents</label><ul class=md-nav__list data-md-component=toc data-md-scrollfix><li class=md-nav__item><a class=md-nav__link href=#key-features-of-numba> <span class=md-ellipsis> Key features of numba </span> </a><li class=md-nav__item><a class=md-nav__link href=#when-to-use-and-to-avoid-numba> <span class=md-ellipsis> When to use and to avoid numba </span> </a><li class=md-nav__item><a class=md-nav__link href=#data-for-testing-demonstration> <span class=md-ellipsis> Data for testing demonstration </span> </a><li class=md-nav__item><a class=md-nav__link href=#initial-version> <span class=md-ellipsis> Initial version </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-numpy-function> <span class=md-ellipsis> Using numpy function </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-numbanjit> <span class=md-ellipsis> Using numba.njit </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-numbanjit-with-data-types> <span class=md-ellipsis> Using numba.njit with data types </span> </a><li class=md-nav__item><a class=md-nav__link href=#replacing-numpy-function-with-a-python-loop> <span class=md-ellipsis> Replacing numpy function with a python loop </span> </a><li class=md-nav__item><a class=md-nav__link href=#using-numbanjit-parallel-mode> <span class=md-ellipsis> Using numba.njit parallel mode </span> </a><li class=md-nav__item><a class=md-nav__link href=#references> <span class=md-ellipsis> References </span> </a></ul></nav></div></div></div><div class=md-content data-md-component=content><article class="md-content__inner md-typeset"><h1 id=make-python-loops-5x-to-10x-faster-using-numba>Make Python Loops 5x to 10x Faster Using Numba<a title="Permanent link" class=headerlink href=#make-python-loops-5x-to-10x-faster-using-numba>¶</a></h1><p>Numba is a just-in-time (JIT) compiler for python that translates python code into highly optimized machine code at runtime. It can significantly improve the performance of numerical computations by enabling high-performance execution of functions, particularly those that make heavy use of numpy arrays.<p>Here we will first briefly explain key features of numba and when to use it, and then provide an example demonstrating how to accelerate code performance by leveraging various numba features. If you are already familiar with numba, go directly to the third section about the demonstration.<h2 id=key-features-of-numba>Key features of numba<a title="Permanent link" class=headerlink href=#key-features-of-numba>¶</a></h2><ul><li><p><strong>JIT compilation</strong>: Numba compiles python functions into machine code, allowing for efficient code generation tailored to specific hardware and data types.</p><li><p><strong>Numerical acceleration</strong>: Numba is particularly well-suited for numerical computations involving arrays and mathematical operations. It can often achieve performance comparable to compiled languages like C or Fortran.</p><li><p><strong>Compatibility with numpy</strong>: Numba seamlessly integrates with numpy, to accelerate numpy functions and operations, making them much faster.</p><li><p><strong>Parallel computing</strong>: Numba supports parallel execution on multi-core CPUs and GPUs, enabling us to leverage the power of parallel hardware to speed up computations.</p><li><p><strong>Custom UDFs</strong>: We can create custom user-defined functions (UDFs) in numba and use them within our python code. These UDFs can be compiled and optimized for performance.</p></ul><h2 id=when-to-use-and-to-avoid-numba>When to use and to avoid numba<a title="Permanent link" class=headerlink href=#when-to-use-and-to-avoid-numba>¶</a></h2><p>Numba is particularly well-suited for numerical computations involving arrays and mathematical operations. Here are some specific cases where we should consider using numba:<ul><li><p><strong>Array operations</strong>: If our code heavily involves operations on numpy arrays, such as element-wise arithmetic, matrix multiplication, or reductions, numba can significantly accelerate these computations.</p><li><p><strong>Mathematical functions</strong>: Numba can optimize calls to mathematical functions like <code>sin</code>, <code>cos</code>, <code>exp</code>, and <code>log</code>, providing a performance boost compared to their python counterparts.</p><li><p><strong>Custom functions</strong>: If we have custom functions that perform numerical calculations, numba can compile them into machine code for improved efficiency.</p><li><p><strong>Loops</strong>: Numba can often optimize loops that iterate over arrays or perform numerical calculations within the loop body.</p></ul><p>However, not all python code can be optimized using numba and thus improve the performance. There are some limitations to consider before using numba:<ul><li><p><strong>I/O bound operations</strong>: Numba will not help much with operations that are I/O bound, such as reading/writing files or network operations.</p><li><p><strong>Dynamic python features</strong>: If our code relies heavily on python's dynamic features (like modifying functions at runtime), numba may not be suitable, as it works best with statically typed, straightforward code.</p><li><p><strong>Non-numerical code</strong>: For code that does not involve numerical calculations or array manipulations, other optimization techniques may be more appropriate.</p><li><p><strong>Numba can introduce overhead</strong>: If we are working with small datasets or functions that run very quickly, the overhead of JIT compilation might outweigh the performance benefits.</p></ul><p>To determine whether numba is appropriate for our use case, we can:<ul><li><p><strong>Profile our code:</strong> Use profiling tools to identify the bottlenecks in our code and see if they involve numerical computations.</p><li><p><strong>Try numba and measure the performance:</strong> Experiment with numba and compare the performance of our code with and without numba.</p><li><p><strong>Consider the trade-offs:</strong> Weigh the potential performance benefits against the overhead and limitations of using numba.</p></ul><p>Overall, if we have numerical or scientific computations that need to be optimized, numba is a powerful tool that can lead to significant performance improvements with minimal code changes.<h2 id=data-for-testing-demonstration>Data for testing demonstration<a title="Permanent link" class=headerlink href=#data-for-testing-demonstration>¶</a></h2><p>Let's create a 2D numpy array filled with randomly generated data. Each row represents a scenario and here we will calculate the distance between any two scenarios.<div class=highlight><pre><span></span><code><a href=#__codelineno-0-1 id=__codelineno-0-1 name=__codelineno-0-1></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
<a href=#__codelineno-0-2 id=__codelineno-0-2 name=__codelineno-0-2></a><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span>
<a href=#__codelineno-0-3 id=__codelineno-0-3 name=__codelineno-0-3></a><span class=n>arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>rand</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>
</code></pre></div><h2 id=initial-version>Initial version<a title="Permanent link" class=headerlink href=#initial-version>¶</a></h2><p>We calculate the distance between two scenarios using the 1-norm, which measures the sum of the absolute differences between corresponding elements.<div class=highlight><pre><span></span><code><a href=#__codelineno-1-1 id=__codelineno-1-1 name=__codelineno-1-1></a><span class=k>def</span><span class=w> </span><span class=nf>calculate_distances1</span><span class=p>(</span><span class=n>arr</span><span class=p>):</span>
<a href=#__codelineno-1-2 id=__codelineno-1-2 name=__codelineno-1-2></a>    <span class=n>m</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<a href=#__codelineno-1-3 id=__codelineno-1-3 name=__codelineno-1-3></a>    <span class=n>n</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
<a href=#__codelineno-1-4 id=__codelineno-1-4 name=__codelineno-1-4></a>    <span class=n>dist_arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>m</span><span class=p>,</span> <span class=n>m</span><span class=p>))</span>
<a href=#__codelineno-1-5 id=__codelineno-1-5 name=__codelineno-1-5></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>m</span><span class=p>):</span>
<a href=#__codelineno-1-6 id=__codelineno-1-6 name=__codelineno-1-6></a>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
<a href=#__codelineno-1-7 id=__codelineno-1-7 name=__codelineno-1-7></a>            <span class=n>v</span> <span class=o>=</span> <span class=mf>0.0</span>
<a href=#__codelineno-1-8 id=__codelineno-1-8 name=__codelineno-1-8></a>            <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
<a href=#__codelineno-1-9 id=__codelineno-1-9 name=__codelineno-1-9></a>                 <span class=n>v</span> <span class=o>+=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>k</span><span class=p>]</span> <span class=o>-</span> <span class=n>arr</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>k</span><span class=p>])</span>
<a href=#__codelineno-1-10 id=__codelineno-1-10 name=__codelineno-1-10></a>            <span class=n>dist_arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span>
<a href=#__codelineno-1-11 id=__codelineno-1-11 name=__codelineno-1-11></a>            <span class=n>dist_arr</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span>
<a href=#__codelineno-1-12 id=__codelineno-1-12 name=__codelineno-1-12></a>    <span class=k>return</span> <span class=n>dist_arr</span>
<a href=#__codelineno-1-13 id=__codelineno-1-13 name=__codelineno-1-13></a><span class=c1># 2.68 s ± 16.8 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</code></pre></div> The run time is about 2.68 seconds, for 100 scenarios. If we have 1000 scenarios the time would be 268 seconds. That is too slow and we must improve the performance. <h2 id=using-numpy-function>Using numpy function<a title="Permanent link" class=headerlink href=#using-numpy-function>¶</a></h2><p>Here we update the code to calculate the 1-norm using the numpy function <code>np.linalg.norm()</code>.<div class=highlight><pre><span></span><code><a href=#__codelineno-2-1 id=__codelineno-2-1 name=__codelineno-2-1></a><span class=k>def</span><span class=w> </span><span class=nf>calculate_distances2</span><span class=p>(</span><span class=n>arr</span><span class=p>):</span>
<a href=#__codelineno-2-2 id=__codelineno-2-2 name=__codelineno-2-2></a>    <span class=n>m</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<a href=#__codelineno-2-3 id=__codelineno-2-3 name=__codelineno-2-3></a>    <span class=n>dist_arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>m</span><span class=p>,</span> <span class=n>m</span><span class=p>))</span>
<a href=#__codelineno-2-4 id=__codelineno-2-4 name=__codelineno-2-4></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>m</span><span class=p>):</span>
<a href=#__codelineno-2-5 id=__codelineno-2-5 name=__codelineno-2-5></a>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
<a href=#__codelineno-2-6 id=__codelineno-2-6 name=__codelineno-2-6></a>            <span class=n>dist_arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>norm</span><span class=p>(</span><span class=n>arr</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>arr</span><span class=p>[</span><span class=n>j</span><span class=p>],</span> <span class=mi>1</span><span class=p>)</span>
<a href=#__codelineno-2-7 id=__codelineno-2-7 name=__codelineno-2-7></a>            <span class=n>dist_arr</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>dist_arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span>
<a href=#__codelineno-2-8 id=__codelineno-2-8 name=__codelineno-2-8></a>    <span class=k>return</span> <span class=n>dist_arr</span>
<a href=#__codelineno-2-9 id=__codelineno-2-9 name=__codelineno-2-9></a><span class=c1># 40.7 ms ± 1.50 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</code></pre></div> Now the run time is 40.7 ms - about <code>65x</code> faster! As the numpy function is implemented in C, there is no surprise that the performance has been improved significantly. <h2 id=using-numbanjit>Using numba.njit<a title="Permanent link" class=headerlink href=#using-numbanjit>¶</a></h2><p>Can we improve the performance further? Yes, by using numba, definitely we can.<div class=highlight><pre><span></span><code><a href=#__codelineno-3-1 id=__codelineno-3-1 name=__codelineno-3-1></a><span class=kn>from</span><span class=w> </span><span class=nn>numba</span><span class=w> </span><span class=kn>import</span> <span class=n>njit</span>
<a href=#__codelineno-3-2 id=__codelineno-3-2 name=__codelineno-3-2></a><span class=nd>@njit</span><span class=p>(</span><span class=n>cache</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a href=#__codelineno-3-3 id=__codelineno-3-3 name=__codelineno-3-3></a><span class=k>def</span><span class=w> </span><span class=nf>calculate_distances3</span><span class=p>(</span><span class=n>arr</span><span class=p>):</span>
<a href=#__codelineno-3-4 id=__codelineno-3-4 name=__codelineno-3-4></a>    <span class=o>...</span>
<a href=#__codelineno-3-5 id=__codelineno-3-5 name=__codelineno-3-5></a><span class=c1># 10.9 ms ± 507 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</code></pre></div> It is great that there is a <code>4x</code> performance improvement with numba on the numpy function. <p>The numba <code>njit</code> decorator is used to compile the python function to optimized machine code in nopython mode. We can also use the <code>jit</code> decorator, which allows the function to fall back to the original python implementation if numba cannot compile it.<p>When we set <code>cache=True</code>, numba stores the compiled function in a cache on disk. So the next time we execute the script, it can load the precompiled function, avoiding the overhead of recompilation.<h2 id=using-numbanjit-with-data-types>Using numba.njit with data types<a title="Permanent link" class=headerlink href=#using-numbanjit-with-data-types>¶</a></h2><p>Can we do it better? Yes, we need to use numba data type signature.<div class=highlight><pre><span></span><code><a href=#__codelineno-4-1 id=__codelineno-4-1 name=__codelineno-4-1></a><span class=nd>@njit</span><span class=p>(</span><span class=s1>'float64[:,::1](float64[:,::1])'</span><span class=p>,</span> <span class=n>cache</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a href=#__codelineno-4-2 id=__codelineno-4-2 name=__codelineno-4-2></a><span class=k>def</span><span class=w> </span><span class=nf>calculate_distances4</span><span class=p>(</span><span class=n>arr</span><span class=p>):</span>
<a href=#__codelineno-4-3 id=__codelineno-4-3 name=__codelineno-4-3></a>    <span class=o>...</span>
<a href=#__codelineno-4-4 id=__codelineno-4-4 name=__codelineno-4-4></a><span class=c1># 10.5 ms ± 208 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</code></pre></div> We explicitly set the data types of the input parameters and the output. In this case, there is only minor performance improvement, most likely that numba can infer data types even without data type signature. More details about the numba data type signature can be found in the numba documents (see References section). <p>In generall, by specifying data types, numba can generate more efficient machine code. Knowing the exact types allows it to optimize the generated code for those types, leading to faster execution and improved memory management.<h2 id=replacing-numpy-function-with-a-python-loop>Replacing numpy function with a python loop<a title="Permanent link" class=headerlink href=#replacing-numpy-function-with-a-python-loop>¶</a></h2><p>As numba is good for loops, here we will replace the numpy function by a <code>python loop</code> to further boost performance.<div class=highlight><pre><span></span><code><a href=#__codelineno-5-1 id=__codelineno-5-1 name=__codelineno-5-1></a><span class=nd>@njit</span><span class=p>(</span><span class=s1>'float64[:,::1](float64[:,::1])'</span><span class=p>,</span> <span class=n>cache</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a href=#__codelineno-5-2 id=__codelineno-5-2 name=__codelineno-5-2></a><span class=k>def</span><span class=w> </span><span class=nf>calculate_distances5</span><span class=p>(</span><span class=n>arr</span><span class=p>):</span>
<a href=#__codelineno-5-3 id=__codelineno-5-3 name=__codelineno-5-3></a>    <span class=n>m</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<a href=#__codelineno-5-4 id=__codelineno-5-4 name=__codelineno-5-4></a>    <span class=n>n</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
<a href=#__codelineno-5-5 id=__codelineno-5-5 name=__codelineno-5-5></a>    <span class=n>dist_arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>m</span><span class=p>,</span> <span class=n>m</span><span class=p>))</span>
<a href=#__codelineno-5-6 id=__codelineno-5-6 name=__codelineno-5-6></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>m</span><span class=p>):</span>
<a href=#__codelineno-5-7 id=__codelineno-5-7 name=__codelineno-5-7></a>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
<a href=#__codelineno-5-8 id=__codelineno-5-8 name=__codelineno-5-8></a>            <span class=n>v</span> <span class=o>=</span> <span class=mf>0.0</span>
<a href=#__codelineno-5-9 id=__codelineno-5-9 name=__codelineno-5-9></a>            <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
<a href=#__codelineno-5-10 id=__codelineno-5-10 name=__codelineno-5-10></a>                 <span class=n>v</span> <span class=o>+=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>k</span><span class=p>]</span> <span class=o>-</span> <span class=n>arr</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>k</span><span class=p>])</span>
<a href=#__codelineno-5-11 id=__codelineno-5-11 name=__codelineno-5-11></a>            <span class=n>dist_arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span>
<a href=#__codelineno-5-12 id=__codelineno-5-12 name=__codelineno-5-12></a>            <span class=n>dist_arr</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span>
<a href=#__codelineno-5-13 id=__codelineno-5-13 name=__codelineno-5-13></a>    <span class=k>return</span> <span class=n>dist_arr</span>
<a href=#__codelineno-5-14 id=__codelineno-5-14 name=__codelineno-5-14></a><span class=c1># 8.20 ms ± 163 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</code></pre></div> Numba is indeed good for loops. There is a <code>1.2x</code> performance improvement now, and it's about <code>5x</code> faster than the numpy version. <h2 id=using-numbanjit-parallel-mode>Using numba.njit parallel mode<a title="Permanent link" class=headerlink href=#using-numbanjit-parallel-mode>¶</a></h2><p>Modern computers often have multiple cores. By leveraging parallel computing, we can significantly reduce execution time.<div class=highlight><pre><span></span><code><a href=#__codelineno-6-1 id=__codelineno-6-1 name=__codelineno-6-1></a><span class=kn>from</span><span class=w> </span><span class=nn>numba</span><span class=w> </span><span class=kn>import</span> <span class=n>njit</span><span class=p>,</span> <span class=n>prange</span>
<a href=#__codelineno-6-2 id=__codelineno-6-2 name=__codelineno-6-2></a><span class=nd>@njit</span><span class=p>(</span><span class=s1>'float64[:,::1](float64[:,::1])'</span><span class=p>,</span> <span class=n>cache</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>parallel</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>nogil</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a href=#__codelineno-6-3 id=__codelineno-6-3 name=__codelineno-6-3></a><span class=k>def</span><span class=w> </span><span class=nf>calculate_distances6</span><span class=p>(</span><span class=n>arr</span><span class=p>):</span>
<a href=#__codelineno-6-4 id=__codelineno-6-4 name=__codelineno-6-4></a>    <span class=n>m</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
<a href=#__codelineno-6-5 id=__codelineno-6-5 name=__codelineno-6-5></a>    <span class=n>n</span> <span class=o>=</span> <span class=n>arr</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
<a href=#__codelineno-6-6 id=__codelineno-6-6 name=__codelineno-6-6></a>    <span class=n>dist_arr</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>m</span><span class=p>,</span> <span class=n>m</span><span class=p>))</span>
<a href=#__codelineno-6-7 id=__codelineno-6-7 name=__codelineno-6-7></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>prange</span><span class=p>(</span><span class=n>m</span><span class=p>):</span>
<a href=#__codelineno-6-8 id=__codelineno-6-8 name=__codelineno-6-8></a>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
<a href=#__codelineno-6-9 id=__codelineno-6-9 name=__codelineno-6-9></a>            <span class=n>v</span> <span class=o>=</span> <span class=mf>0.0</span>
<a href=#__codelineno-6-10 id=__codelineno-6-10 name=__codelineno-6-10></a>            <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
<a href=#__codelineno-6-11 id=__codelineno-6-11 name=__codelineno-6-11></a>                 <span class=n>v</span> <span class=o>+=</span> <span class=nb>abs</span><span class=p>(</span><span class=n>arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>k</span><span class=p>]</span> <span class=o>-</span> <span class=n>arr</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>k</span><span class=p>])</span>
<a href=#__codelineno-6-12 id=__codelineno-6-12 name=__codelineno-6-12></a>            <span class=n>dist_arr</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span>
<a href=#__codelineno-6-13 id=__codelineno-6-13 name=__codelineno-6-13></a>            <span class=n>dist_arr</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span>
<a href=#__codelineno-6-14 id=__codelineno-6-14 name=__codelineno-6-14></a>    <span class=k>return</span> <span class=n>dist_arr</span>
<a href=#__codelineno-6-15 id=__codelineno-6-15 name=__codelineno-6-15></a><span class=c1># 3.68 ms ± 157 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</span>
</code></pre></div> Here we update the code to use numba <code>parallel mode</code> with the help of the <code>prange</code> function. <p>By setting <code>parallel=True</code>, numba's JIT compiler will analyze the function's code and automatically identify opportunities for parallelization, especially within loops. However, using <code>prange</code> provides more explicit control over parallelization and can be more effective in certain cases.<p>Finally the run time is 3.68 ms (4 cpu cores). It is about <code>10x</code> faster compared to the numpy function version without using numba.njit (40.7 ms). It is about <code>700x</code> faster compared to the raw python code (2.68 seconds).<h2 id=references>References<a title="Permanent link" class=headerlink href=#references>¶</a></h2><ul><li><p><a href=https://numba.pydata.org/numba-doc/dev/reference/types.html>Numba data type signature</a></p><li><p><a href=https://stackoverflow.com/questions/66205186/python-signature-with-numba>Numba data type signature caveats</a></p><li><p><a href=https://pythonspeed.com/articles/slow-numba>Optimizing python loops using numba</a></p></ul></article></div><script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script></div><button class="md-top md-icon" data-md-component=top hidden type=button><svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top</button></main><footer class=md-footer><div class="md-footer-meta md-typeset"><div class="md-footer-meta__inner md-grid"><div class=md-copyright><div class=md-copyright__highlight><a title="Go to Main Home Page" href=/>🏠 Back to Home</a><br> Copyright © 2026 Sean Ma <br>Last updated on <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-custom" title="March 16, 2025 01:22:45 UTC">16 Mar 2025</span></div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ rel=noopener target=_blank> Material for MkDocs </a></div></div></div></footer></div><div class=md-dialog data-md-component=dialog><div class="md-dialog__inner md-typeset"></div></div><script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.expand", "navigation.indexes", "navigation.top", "toc.follow", "search.suggest", "search.highlight", "content.code.copy", "navigation.prune"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script><script src=../../../assets/javascripts/bundle.56ea9cef.min.js></script>